#Architecture
---
#doc
[架构之路（一）：目标](http://www.csdn.net/article/2015-09-22/2825768)
[架构之路（二）：性能](http://www.csdn.net/article/2015-09-22/2825773)
[架构之路（三）：单元测试](http://www.csdn.net/article/2015-09-22/2825774)
[架构之路（四）：测试驱动]()
[淘宝大秒系统设计详解](http://geek.csdn.net/news/detail/59847)
[途牛网站无线架构变迁实践](http://geek.csdn.net/news/detail/55369)


---
#面对的问题
* 高并发，大流量
* 高可用
* 海量数据
* 用户分布广，网络情况复杂
* 安全环境恶劣
* 需求变更快，发布频繁

---
#定义
wiki:有关软件整体结构与组件的抽象描述，用于指导大型软件系统各个方面的设计。

---
#演化
单机
应用数据分离
缓存
服务集群
读写分离
CDN 反向代理
nosql，搜索引擎
业务拆分
分布式

---
#设计误区
一味追求大公司方案
为了技术而技术
企图用技术解决所有问题

---
#[架构模式](./ArchPattern.md)

---
#架构要素
##性能
解决性能问题，我们可以有很多代码以外行之有效的方法，而可维护性基本上就只能靠代码了
过早的优化是万恶之源
优化首先需要找到性能“瓶颈”。否则，任何人都可以随手一指，“这段代码需要优化”
可读性更强的代码总是更好优化
硬件永远比软件便宜

衡量：响应时间、TPS、计数器

##可用性
服务可用
数据可用

##伸缩性
不断加入服务器缓解并发压力和数据
事件驱动，分布式服务

##扩展性
增加新业务对现有业务透明无影响，不需要改动或很少改动既有业务

##安全性

----
#高性能架构
##性能测量指标
* 响应时间      
    响应性，如响应后，但短时间无法处理，但给出处理进度条
    重复请求总时间/请求数
    等待时间
* 并发数       
    思考时间

* 吞吐量       
    单位时间内系统处理请求数
    TPS 每秒事务数
    HPS 每秒HTTP请求数
    QPS 每秒查询数

* 性能计数器     
    system load，系统负载，当前cpu执行和等待被执行的进程数目总和
* 负载
    负载敏感度，响应时间随负载变化程度


##性能测量方法
* 性能测试      
    测资源在可接受范围内，能否达到性能预期
* 负载测试      
    并发请求，测临界值
* 压力测试
    超过安全负载继续施加压力，系统最大承受力
* 稳定性测试

系统最大负载点
系统崩溃点
随时间的变化，随环境(用户差异，存储量，数据量，系统的优化，硬件的更换……)的变化
长尾效应，多个子因素共同提升后带来整体性能提升

##性能优化
###web前端
减少http请求：合并css,js,图片
浏览器缓存：http头的cache-control、expires属性
启用压缩：会对服务器产品一定压力
css页面最上、js页面最下
减少cookie传输：静态资源单独域名，减少cookie传输次数
CDN加速：
反向代理：缓存、负载均衡

###应用服务器
* 缓存        
    读写比
    热点数据
    数据不一致、脏读
    缓存可用性
    缓存预热
    缓存穿透，缓存不存在数据
缓存架构
    同步更新
    集中式

* 异步操作

* 集群

* 代码优化
    多线程
        启动线程数=[任务执行时间/(任务执行时间-IO等待时间)]xCPU内核数
        无状态，贫血模型
        局部对象
        锁
    资源复用
        单例
        对象池
    数据结构
    垃圾回收

##存储
LSM树


---
#高可用性架构
##指标
不可用时间=修复时间点-发现时间点
可用性指标=（1-不可用时间/年度总时间）x100%
99% 88h
99.9% 9h
99.99% 53m
99.999% 5m

分类
    事故级 | 严重，整体不可用 | 100
    A类 | 核心不可用 | 20
    B类 | 非核心不可用 | 5
    C类 | 以上之外 | 1
故障分=故障时间(min)x故障权重

##架构
不同层、不同业务集群部署

无状态失效转移
状态保存在外部

##高可用数据
CAP原理
P持久性
A可访问性
C一致性
    强一致
    用户一致
    最终一致

失效转移
    失效确认
    访问转移
    数据恢复

##高可用网站软件质量保证
发布，集群部分挨个发布
测试
    selenium
预发布
代码控制
自动化发布
火车发布
灰度发布

##监控
数据采集
    行为日志
    客户端浏览日志
    服务器性能监控
    运行数据报告
监控管理
    系统报警
    失效转移
    优雅降级

---
#伸缩性
* 不同功能，根据功能进行物理分离
* 单一功能，多台服务器部署相同服务

##应用集群伸缩
无状态
    负载均衡
        dns负载均衡（第一层）
            控制权在域名服务商
        反向代理负载均衡
        IP负载均衡
            网络层负载均衡
            关键：web服务器响应数据怎么返回给负载均衡Server
                SNAT源地址转换，负载server把包数据源地址改为自身
                把负载server作为真实服务器集群的网关服务器
        算法
            轮询RR
            加权轮询
            随机
            最少连接
            源地址散列

##数据集群伸缩
###分布式缓存集群伸缩性
余数hash
    增加机器不能命中概率99%(N/(N+1))
一致性hash
    二叉查找树
    虚节点解决分布均衡问题

##数据存储集群伸缩性设计
###关系型
分库，跨库无法join
分片
主从
* 中间件
    cobar
    ameoba
    GreenPlum，支持join适合OLAP
###noSQL
重点：高可用；伸缩性
* hbase
    hregion为单位，每个hregion存储一段key值区间
    HMaster通过zk选举一个主服务器
```
app                     zk               HMaster       HregionServer    HRegion
|   --请求hmaster地址->  |
|   -----输入key，请求HregionServer地址-->|
|   -----输入key，查询数据----------------------------->|
|                                                       |--访问Hrigion实例->|
```

---
#扩展性
开闭原则，扩展新功能不需要修改现有系统结构和代码
##分布式消息队列
事件驱动EventDrivenArchitecture
消费者-生产者
可用性
    内存已满，磁盘写入
    暂存在生产者硬盘，真正处理完后，再删除

##分布式服务
* 初期困难
    - 编译、部署
    - 代码分支管理
    - 数据库连接
    - 新增业务
* 解决方案
    - 横向拆分，拆出复用业务
    - 纵向拆分，规范接口、依赖关系
* webservice
    - 缺点
        + 臃肿的注册发现机制
        + 抵消的xml序列化手段
        + 开销较高的http通信
        + 复杂的部署与维护手段
* 目标
    - 负载均衡
    - 失效转移
    - 高效通信
    - 整合异构系统
    - 对应用最少入侵
    - 版本管理
    - 实时监控  
* dubbo
* 可扩展数据结构
    - 列族
* 对外API
    - 协议转换
    - 审计
    - 安全
    - 路由
    - 流程

---
#安全
##[攻击方式](./Security/Base.sec.md)




---
#维护
    扩展

---
#成本

---
#模块划分


---
#业务
按业务需求来使用技术
驱动技术的是业务发展
##不要企图用技术解决所有问题
技术用来解决业务问题，而技术上很难实现的业务问题也可以用业务来解决






---
#架构师的职能
管理相关：
    规划产品路线
    人力资源估算
    时间资源
    人员职责分工
    确定计划里程碑点
    指导工程师工作
    过程风险评估与控制




















